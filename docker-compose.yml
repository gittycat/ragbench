services:
  # WebApp - SvelteKit frontend for RAG system
  webapp:
    build:
      context: ./services/webapp
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8000:3000"
    environment:
      - ORIGIN=http://localhost:8000
      - RAG_SERVER_URL=http://rag-server:8001
      - MAX_UPLOAD_SIZE=80
    depends_on:
      rag-server:
        condition: service_healthy
    networks:
      - public
      - private

  # RAG Server - API service for document processing and querying
  rag-server:
    build:
      context: .
      dockerfile: ./services/rag_server/Dockerfile
    user: "1000:1000"
    restart: unless-stopped
    ports:
      - "8001:8001"
    secrets:
      - openai-api-key
      - anthropic-api-key
    environment:
      - OPENAI_API_KEY=/run/secrets/openai-api-key
      - ANTHROPIC_API_KEY=/run/secrets/anthropic-api-key
      - DATABASE_URL=postgresql+asyncpg://raguser:ragpass@postgres:5432/ragbench
      - LOG_LEVEL=WARNING
      - MAX_UPLOAD_SIZE=80
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health', timeout=2)"]
      interval: 2s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - private
      - public
    volumes:
      - ./config.yml:/app/config.yml:ro       # Model configuration (read-only)
      - ./data/indexed_documents:/app/documents
      - docs_repo:/tmp/shared
      - huggingface_cache:/home/appuser/.cache/huggingface
      - documents_data:/data/documents

  # PostgreSQL with pgvector + pg_search (ParadeDB) + pgmq
  postgres:
    build:
      context: ./services/postgres
      dockerfile: Dockerfile
    environment:
      POSTGRES_USER: raguser
      POSTGRES_PASSWORD: ragpass
      POSTGRES_DB: ragbench
    volumes:
      - postgres_data:/var/lib/postgresql
      - ./services/postgres/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U raguser -d ragbench"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - private
    restart: unless-stopped

  # PGMQ Worker - Async document processing via PostgreSQL queue
  pgmq-worker:
    build:
      context: .
      dockerfile: ./services/rag_server/Dockerfile
    command: [".venv/bin/python", "-m", "infrastructure.tasks.pgmq_worker"]
    user: "1000:1000"
    restart: unless-stopped
    secrets:
      - openai-api-key
      - anthropic-api-key
    environment:
      - OPENAI_API_KEY=/run/secrets/openai-api-key
      - ANTHROPIC_API_KEY=/run/secrets/anthropic-api-key
      - DATABASE_URL=postgresql+asyncpg://raguser:ragpass@postgres:5432/ragbench
      - LOG_LEVEL=WARNING
      - MAX_UPLOAD_SIZE=80
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy
      rag-server:
        condition: service_healthy
    networks:
      - private
      - public
    volumes:
      - ./config.yml:/app/config.yml:ro       # Model configuration (read-only)
      - ./data/indexed_documents:/app/documents
      - docs_repo:/tmp/shared
      - huggingface_cache:/home/appuser/.cache/huggingface
      - documents_data:/data/documents

  # Evals Service - CLI-based evaluation (profile-gated)
  evals:
    build:
      context: .
      dockerfile: ./services/evals/Dockerfile
    volumes:
      - ./config.yml:/app/config.yml:ro
      - ./services/evals/evals/data:/app/evals/data
    secrets:
      - openai-api-key
      - anthropic-api-key
    environment:
      - OPENAI_API_KEY=/run/secrets/openai-api-key
      - ANTHROPIC_API_KEY=/run/secrets/anthropic-api-key
    networks:
      - private
    profiles:
      - eval
    depends_on:
      rag-server:
        condition: service_healthy

# Network configuration for security isolation
networks:
  public:
    driver: bridge
  private:
    driver: bridge
    internal: true

# Persistent volumes
volumes:
  postgres_data:
    driver: local
  docs_repo:
    driver: local
  huggingface_cache:
    driver: local
  documents_data:
    driver: local

secrets:
  openai-api-key:
    file: secrets/.env.openai
  anthropic-api-key:
    file: secrets/.env.anthropic

