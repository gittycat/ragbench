services:
  # WebApp - SvelteKit frontend for RAG system
  webapp:
    build:
      context: ./services/webapp
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8000:3000"
    environment:
      - ORIGIN=http://localhost:8000
      - RAG_SERVER_URL=http://rag-server:8001
      - MAX_UPLOAD_SIZE=80
    depends_on:
      rag-server:
        condition: service_healthy
    networks:
      - public
      - private

  # RAG Server - API service for document processing and querying
  rag-server:
    build:
      context: .
      dockerfile: ./services/rag_server/Dockerfile
    user: "1000:1000"
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      # Database
      - CHROMADB_URL=http://chromadb:8000
      - REDIS_URL=redis://redis:6379/0
      # API Keys (from secrets/.env)
      - LLM_API_KEY=${LLM_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # Application Settings
      - LOG_LEVEL=WARNING
      - MAX_UPLOAD_SIZE=80                # Max file upload size in MB
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      chromadb:
        condition: service_started
      redis:
        condition: service_started
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health', timeout=2)"]
      interval: 2s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - private
      - public
    volumes:
      - ./config:/app/config:ro               # Model configuration (read-only)
      - ./data/indexed_documents:/app/documents
      - ./services/rag_server/eval_data:/app/eval_data  # Evaluation results
      - docs_repo:/tmp/shared
      - huggingface_cache:/home/appuser/.cache/huggingface
      - documents_data:/data/documents
    secrets:
      - ollama_config

  # ChromaDB Vector Database (private network only)
  chromadb:
    image: chromadb/chroma:latest
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
      - CHROMA_LOG_CONFIG=/chroma/log_config.yml
    volumes:
      - chromadb_data:/chroma/chroma
      - ./services/chromadb/log_config.yml:/chroma/log_config.yml:ro
    networks:
      - private
    restart: unless-stopped

  # Redis - Message broker and result backend for Celery
  redis:
    image: redis:8-alpine
    command: redis-server --loglevel warning --save 60 1000 --appendonly yes --appendfsync everysec
    volumes:
      - redis_data:/data
    networks:
      - private
    restart: unless-stopped

  # Celery Worker - Async document processing (documents queue)
  celery-worker:
    build:
      context: .
      dockerfile: ./services/rag_server/Dockerfile
    command: [".venv/bin/celery", "--quiet", "-A", "infrastructure.tasks.celery_app", "worker", "-Q", "celery,documents", "--concurrency=1", "--without-mingle", "--without-gossip"]
    user: "1000:1000"
    restart: unless-stopped
    environment:
      # Database
      - CHROMADB_URL=http://chromadb:8000
      - REDIS_URL=redis://redis:6379/0
      # API Keys (from secrets/.env)
      - LLM_API_KEY=${LLM_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # Application Settings
      - LOG_LEVEL=WARNING
      - MAX_UPLOAD_SIZE=80                # Max file upload size in MB
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_started
      chromadb:
        condition: service_started
      rag-server:
        condition: service_healthy
    networks:
      - private
      - public
    volumes:
      - ./config:/app/config:ro               # Model configuration (read-only)
      - ./data/indexed_documents:/app/documents
      - ./services/rag_server/eval_data:/app/eval_data  # Evaluation results
      - docs_repo:/tmp/shared
      - huggingface_cache:/home/appuser/.cache/huggingface
      - documents_data:/data/documents
    secrets:
      - ollama_config

  # Celery Eval Worker - Async evaluation processing (eval queue)
  eval-worker:
    build:
      context: .
      dockerfile: ./services/rag_server/Dockerfile
    command: [".venv/bin/celery", "--quiet", "-A", "infrastructure.tasks.celery_app", "worker", "-Q", "eval", "--concurrency=1", "--without-mingle", "--without-gossip"]
    user: "1000:1000"
    restart: unless-stopped
    environment:
      # Database
      - CHROMADB_URL=http://chromadb:8000
      - REDIS_URL=redis://redis:6379/0
      # API Keys (from secrets/.env)
      - LLM_API_KEY=${LLM_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # Application Settings
      - LOG_LEVEL=WARNING
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_started
      rag-server:
        condition: service_healthy
    networks:
      - private
      - public
    volumes:
      - ./config:/app/config:ro               # Model configuration (read-only)
      - ./services/rag_server/eval_data:/app/eval_data  # Evaluation data and results
      - ./services/rag_server/data:/app/data            # Evaluation run storage
      - huggingface_cache:/home/appuser/.cache/huggingface
    secrets:
      - ollama_config

# Network configuration for security isolation
networks:
  public:
    driver: bridge
  private:
    driver: bridge
    internal: true

# Persistent volumes
volumes:
  chromadb_data:
    driver: local
  redis_data:
    driver: local
  docs_repo:
    driver: local
  huggingface_cache:
    driver: local
  documents_data:
    driver: local

# Secrets management
secrets:
  ollama_config:
    file: ./secrets/ollama_config.env 