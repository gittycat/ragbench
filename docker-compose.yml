services:
  # WebApp - SvelteKit frontend for RAG system
  webapp:
    build:
      context: ./services/webapp
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8000:3000"
    environment:
      - ORIGIN=http://localhost:8000
      - RAG_SERVER_URL=http://rag-server:8001
      - MAX_UPLOAD_SIZE=80
    depends_on:
      rag-server:
        condition: service_healthy
    networks:
      - public
      - private

  # RAG Server - API service for document processing and querying
  rag-server:
    build:
      context: .
      dockerfile: ./services/rag_server/Dockerfile
    user: "1000:1000"
    restart: unless-stopped
    ports:
      - "8001:8001"
    secrets:
      - OPENAI_API_KEY
      - ANTHROPIC_API_KEY
      - RAG_SERVER_DB_USER
      - RAG_SERVER_DB_PASSWORD
    environment:
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=ragbench
      - LOG_LEVEL=WARNING
      - MAX_UPLOAD_SIZE=80
      - SHARED_UPLOAD_DIR=/tmp/shared
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health', timeout=2)"]
      interval: 2s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - private
      - public
    volumes:
      - ./config.yml:/app/config.yml:ro       # Model configuration (read-only)
      - ./data/indexed_documents:/app/documents
      - docs_repo:/tmp/shared
      - ./.hf_cache:/home/appuser/.cache/huggingface

  # PostgreSQL with pgvector + pg_search (ParadeDB) + pgmq
  postgres:
    build:
      context: ./services/postgres
      dockerfile: Dockerfile
    environment:
      POSTGRES_USER_FILE: /run/secrets/POSTGRES_SUPERUSER
      POSTGRES_PASSWORD_FILE: /run/secrets/POSTGRES_SUPERPASSWORD
      POSTGRES_DB: ragbench
    secrets:
      - POSTGRES_SUPERUSER
      - POSTGRES_SUPERPASSWORD
      - RAG_SERVER_DB_USER
      - RAG_SERVER_DB_PASSWORD
    volumes:
      - postgres_data:/var/lib/postgresql
      - ./services/postgres/00-roles.sh:/docker-entrypoint-initdb.d/00-roles.sh:ro
      - ./services/postgres/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
      - ./services/postgres/02-grants.sh:/docker-entrypoint-initdb.d/02-grants.sh:ro
    command: postgres -c max_connections=200
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $(cat /run/secrets/POSTGRES_SUPERUSER) -d ragbench"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - private
    restart: unless-stopped

  # PGMQ Worker - Async document processing via PostgreSQL queue
  pgmq-worker:
    build:
      context: .
      dockerfile: ./services/rag_server/Dockerfile
    command: [".venv/bin/python", "-m", "infrastructure.tasks.pgmq_worker"]
    user: "1000:1000"
    restart: unless-stopped
    secrets:
      - OPENAI_API_KEY
      - ANTHROPIC_API_KEY
      - RAG_SERVER_DB_USER
      - RAG_SERVER_DB_PASSWORD
    environment:
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=ragbench
      - LOG_LEVEL=WARNING
      - MAX_UPLOAD_SIZE=80
      - SHARED_UPLOAD_DIR=/tmp/shared
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy
      rag-server:
        condition: service_healthy
    networks:
      - private
      - public
    volumes:
      - ./config.yml:/app/config.yml:ro       # Model configuration (read-only)
      - ./data/indexed_documents:/app/documents
      - docs_repo:/tmp/shared
      - ./.hf_cache:/home/appuser/.cache/huggingface

  # Evals Service - CLI-based evaluation (profile-gated)
  evals:
    build:
      context: .
      dockerfile: ./services/evals/Dockerfile
    volumes:
      - ./config.yml:/app/config.yml:ro
      - ./services/evals/evals/data:/app/evals/data
    secrets:
      - OPENAI_API_KEY
      - ANTHROPIC_API_KEY
    networks:
      - private
    profiles:
      - eval
    depends_on:
      rag-server:
        condition: service_healthy

# Network configuration for security isolation
networks:
  public:
    driver: bridge
  private:
    driver: bridge
    internal: true

# Persistent volumes
volumes:
  postgres_data:
    driver: local
  docs_repo:
    driver: local

secrets:
  OPENAI_API_KEY:
    file: secrets/OPENAI_API_KEY
  ANTHROPIC_API_KEY:
    file: secrets/ANTHROPIC_API_KEY
  POSTGRES_SUPERUSER:
    file: secrets/POSTGRES_SUPERUSER
  POSTGRES_SUPERPASSWORD:
    file: secrets/POSTGRES_SUPERPASSWORD
  RAG_SERVER_DB_USER:
    file: secrets/RAG_SERVER_DB_USER
  RAG_SERVER_DB_PASSWORD:
    file: secrets/RAG_SERVER_DB_PASSWORD
